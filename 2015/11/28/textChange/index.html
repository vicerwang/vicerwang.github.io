<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 跨浏览器监听用户输入 · Vic's Posts</title><meta name="description" content="跨浏览器监听用户输入 - vic"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/vicerwang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="https://www.zhihu.com/people/wang-jin-liang-69" target="_blank" class="nav-list-link">ZHIHU</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">跨浏览器监听用户输入</h1><div class="post-meta"><div class="post-time">2015年11月28日</div></div><div class="post-content"><p>在前端的开发中，我们经常面临着这样的需求，需要统计在<code>input[type=text]</code>或者<code>textarea</code>中用户输入的字数，以便给用户一些输入限制的提示，那么我们如何实现跨浏览器的监听用户在文本框的输入呢？</p>
<a id="more"></a>
<p>比如我们有如下的html结构，需要将用户在<code>#textbox</code>中输入的字数显示在<code>#counter</code>中：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">textarea</span> <span class="attribute">id</span>=<span class="value">"textbox"</span>&gt;</span><span class="tag">&lt;/<span class="title">textarea</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"counter"</span>&gt;</span>0<span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>先让我们看一下都有哪些方法可以监听用户的输入？</p>
<h2 id="change_u4E8B_u4EF6"><a href="#change_u4E8B_u4EF6" class="headerlink" title="change事件"></a>change事件</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> $counter = $(<span class="string">'#counter'</span>);</span><br><span class="line">$(<span class="string">'#textbox'</span>).on(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $counter.text($(<span class="keyword">this</span>).val().length);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>chang事件是表单元素非常常用的一个事件了，被用来监听表单元素值的变化，但是在<code>input[type=text]</code>和<code>textarea</code>中监听用户输入，却有一个很大的限制，那就是它只有在焦点离开文本框的时候，才会触发，可是这样的用户体验并不能称之为好，我们往往需要的是实时监听。</p>
<h2 id="keydown_u4E8B_u4EF6/keyup_u4E8B_u4EF6"><a href="#keydown_u4E8B_u4EF6/keyup_u4E8B_u4EF6" class="headerlink" title="keydown事件/keyup事件"></a>keydown事件/keyup事件</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> $counter = $(<span class="string">'#counter'</span>);</span><br><span class="line">$(<span class="string">'#textbox'</span>).on(<span class="string">'keydown'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $counter.text($(<span class="keyword">this</span>).val().length);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>keydown事件和keyup事件差不多，都是监听用户在键盘按键的事件，区别在于前者在按下时触发，后者在抬起时触发，对于我们的应用场景，显然keydown的体验要好些。但是它的问题在于不能监听到用户所有的输入方式，比如在文本框点击鼠标右键弹出菜单的剪贴，删除，撤销选项。</p>
<h2 id="input_u4E8B_u4EF6/propertychange_u4E8B_u4EF6"><a href="#input_u4E8B_u4EF6/propertychange_u4E8B_u4EF6" class="headerlink" title="input事件/propertychange事件"></a>input事件/propertychange事件</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> $counter = $(<span class="string">'#counter'</span>);</span><br><span class="line">$(<span class="string">'#textbox'</span>).on(<span class="string">'input'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $counter.text($(<span class="keyword">this</span>).val().length);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>input事件是HTML5新增加的事件，用于监听用户输入，它可以完美的监听到用户按键输入或者右键菜单的操作，但是同样的它并不支持IE8及其以下版本，但是在IE的低版本中我们可以通过监听propertychange事件达到同样的效果，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> $counter = $(<span class="string">'#counter'</span>);</span><br><span class="line">$(<span class="string">'#textbox'</span>).on(<span class="string">'propertychange'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">window</span>.event.propertyName === <span class="string">'value'</span> &amp;&amp; $counter.text($(<span class="keyword">this</span>).val().length);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>以为两个事件都监听就完事大吉了，不幸的是，IE9虽然两个事件都支持，但是却同样有一个Bug，无法监听到任何文字减少相关输入的操作，包括按退格键，选中一段文字按delete键或者右键菜单删除，选中一段文字<code>Ctrl+X</code>剪切或者右键菜单剪贴，<code>Ctrl+Z</code>撤销刚才的输入或者右键菜单撤销，我就这个问题，还去<a href="http://www.zhihu.com/question/31167279" target="_blank" rel="external">知乎提问过</a>，当时觉得可能除了设置定时器循环查看，也没有什么好的办法了，前一阵子在stackoverfollow偶然看到了这个问题的解决办法，现在将兼容IE9监听用户输入的方案分享在这里：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> $textbox = $(<span class="string">'#textbox'</span>);</span><br><span class="line"><span class="keyword">var</span> $counter = $(<span class="string">'#counter'</span>);</span><br><span class="line">$textbox.on(<span class="string">'input'</span>, textChange).on(<span class="string">'focus'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">'selectionchange'</span>, textChange);</span><br><span class="line">&#125;).on(<span class="string">'blur'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.removeEventListener(<span class="string">'selectionchange'</span>, textChange);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">textChange</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $counter.text($textbox.val().length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在IE9中删除文字会触发document的selectionchange事件，对此监听就相当于监听了删除文字相关操作的事件。</p>
<h3 id="u517C_u5BB9_u65B9_u6848"><a href="#u517C_u5BB9_u65B9_u6848" class="headerlink" title="兼容方案"></a>兼容方案</h3><p>最后的兼容代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> $counter = $(<span class="string">'#counter'</span>);</span><br><span class="line"><span class="keyword">var</span> $textbox = $(<span class="string">'#textbox'</span>);</span><br><span class="line"><span class="keyword">var</span> textChange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $counter.text($textbox.val().length);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> _IE = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> v = <span class="number">3</span>,</span><br><span class="line">        div = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>),</span><br><span class="line">        all = div.getElementsByTagName(<span class="string">'i'</span>);</span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">        div.innerHTML = <span class="string">'&lt;!--[if gt IE '</span> + (++v) + <span class="string">']&gt;&lt;i&gt;&lt;/i&gt;&lt;![endif]--&gt;'</span>,</span><br><span class="line">        all[<span class="number">0</span>]</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> v &gt; <span class="number">4</span> ? v : <span class="literal">false</span>;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (_IE &amp;&amp; _IE &lt; <span class="number">9</span>) &#123;</span><br><span class="line">    $textbox.on(<span class="string">'propertychange'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">window</span>.event.propertyName === <span class="string">'value'</span> &amp;&amp; textChange();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $textbox.on(<span class="string">'input'</span>, textChange);</span><br><span class="line">    <span class="keyword">if</span> (_IE === <span class="number">9</span>) &#123;</span><br><span class="line">        $textbox.on(<span class="string">'focus'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">document</span>.addEventListener(<span class="string">'selectionchange'</span>, textChange);</span><br><span class="line">        &#125;).on(<span class="string">'blur'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">document</span>.removeEventListener(<span class="string">'selectionchange'</span>, textChange);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2015/11/29/textareaAutosize/" class="prev">上一篇</a><a href="/2015/11/18/inputfile/nativePreview/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'fedviccom';
var disqus_identifier = '2015/11/28/textChange/';
var disqus_title = '跨浏览器监听用户输入';
var disqus_url = 'http://fedvic.com/2015/11/28/textChange/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//fedviccom.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2016 <a href="http://fedvic.com">vic</a>, unless otherwise noted.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>